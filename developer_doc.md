Overview
========

This is the developer's document for Pifi Android. PiFi Android is a mobile app that does offline content sharing with other mobile phones, and it is also an offline content viewer. It is capable of sharing and receiving content from other phones using bluetooth and also receiving content from a desktop through USB.

Setup
=====

1. Download and install Android SDK bundle from http://developer.android.com/sdk/index.html. This bundle includes Eclipse IDE.
2. Get the code from github. You need to sign up for Github account if you don't have one already. Go to https://github.com/ISI-code/PiFiMobile, click on 'fork', you will get your copy of the code in your repository. Then you can go to your repository and clone the code to your computer. 
3. Import project into Eclipse. (If you get compile errors, check the next section for possible issues.)
4. Get the content pacakges and put it on the test phone.  https://www.dropbox.com/s/dklqlsvuwjdhv30/PifiContent.zip. Extract PifiContent.zip and put the files on the phone under sdcard/PifiContent/. 
5. Connect the phone to computer, from Eclipse, use Run as or Debug as on the project, then pick your phone from the list.

Compile Errors
--------------

If you get compile errors, you might need to update your Android API. Click on the Android SDK Manager icon on top and make sure you have the followings installed:

* Android 4.2.2 (API 17) or higher 
* Extra/Google Support Library

If you get compile error with the layout file res/layout/content_activity.xml, try the following. Right click on the project, select Android Tools > Add Support Library.

Additional Setup
----------------

If you are dealing with the metadata and need to modify the metadata definition files, you also need to install protocol buffer. To download and setup protocol buffer, see https://code.google.com/p/protobuf/.

Good to Know
==============

When programming on Android, everything runs on the UI thread. It’s a practice to put all the background/long process on separate threads to not block the UI.

Content Package and Metadata
============================

The content pacakge contains videos and web articles downloaded from the internet. Inside the package are also two metadata files; videos.date and articles.dat. They contain the video and web entries for each of the content in the package. The Android app reads these metadata files to aggregrate the list of contents available in the content package.

We use Google's protocol buffer format for the metadata. There are three metadata description files in the project's root directory; article.proto, comment.proto, video.proto. Three corresponding java files are generated by the protocol buffer compiler; ArticleProto.java, CommentProto.java, VideoProto.java. If you want to modify any of these description files, you will need to recompile to generate new java classes.

Compile Protocol Buffers
------------------------

Use this command to generate the java classes.  
`protoc -I=src --java_out=src src/article.proto, video.proto, comment.proto`

Activities
==========

ContentListActivity
-------------------

This is the app’s main screen which lists all the contents in the content folder.

    TODO 
    * Need category for web pages
    * Need a better way to get the list of categories. Right now we have to go through the whole list of contents.

### `onCreate(Bundle)`
* Gets the list of content by from the video and web metadata
* Initializes ContentListAdapter which provides data to the ListView
* Handles user click on the content list
* Initializes the menu drawer with list filters; type and category

### `onConfigurationChanged(Configuration)`
When `onCreate()` call is not desired, by adding the `android:onConfigChanges` to the activity entry in the AndroidManifest file, `onConfigurationChanged()` is called instead of `onCreate()`. In our app, we do this for orientation changes.

### `onOptionsItemSelected(MenuItem)`
Handles action bar menu selection event.

### `onSaveInstanceState(Bundle)`
Saves the state of the activity that should be restored in onCreate.

### `onRestoreInstanceState(Bundle)`
Restores the activity’s state.

### `onNavigateUp()`
This handles the event when user click on the top-left icon. In this activity, the menu drawer is opened.

### `onResume()`
Registers to receive broadcast messages. Handles the following messages;
* `NEW_COMMENT_ACTION`: This is a add comment request. Calls `addComment()` to handle adding new comment into the metadata.
* `META_UPDATED_ACTION`: When metadata has been changed, `ContentListAdapater` is reloaded so that the changes can be reflected in the list view.

### `onDestroy()`
Unregisters broadcast receiver.

### `applyListFilter(DrawerItem)`
This method applies the filters (type, category) to the content list view.

### `addComment()`
Add user comment to the metadata. This requires reconstruction of a new metadata and overwriting the existing metadata file.

ContentViewerActivity
---------------------

This activity contains sliding pages (`Fragment`) to handles the viewing of individual content after user clicked an item from the `ContentListActivity`. User can swipe or use the tabs to go through the pages. 

### `onCreate(Bundle)`
* Creates tabs for the pages and initialize tab listener. 
* Initializes Fragments. 
* Initializes swip listener.

### `getFragments()`
Creates the fragments for the content.
* `VideoPlayerFragment` or `HtmlFragment` show the video and web content.
* `DescriptionFragment` shows the description of the content.
* `CommentsFragment` shows user comments and allows user to add comments.

### `onNavigateUp()`
Overrides this method to go back to the parent activity and change the transition animation to slide from left to right.

FullscreenVideoActivity
-----------------------

This is the view for the full screen video. We use the VideoView to display the video but writes a customized video controller `VideoControllerView`. 

Services
========

None right now

Fragments
=========

VideoPlayerFragment
-------------------

Uses ViewView to show the video. Replaces default video controller with a  customized video controller `VideoControllerView` which allows fullscreen option.

### `onSaveInstanceState(Bundle)`
Save the current video position.

### `onPause()`
Save the current video position.

### `onResume()`
Set video position to where it stopped.

### `onActivityResult()`
Implemented this so that when fullscreen returns back here we have the position where video was at.

### `toggleFullScreen()`
Go to fullscreen activity and start where the video left off.

HtmlFragment
------------

Displays the web content using WebView

DescriptionFragment
-------------------

Shows the individual content's description

    TODO Need description for web pages

CommentFragment
---------------

* Shows the list of comments for the content.
* Handles new user comment by broadcasting a new `NEW_COMMENT_ACTION` intent.

View
====

VideoControllerView
-------------------
The default video controller for the VideoView does not have the fullscreen option. Therefore we use a customized video controller with more advanced options like fullscreen/shrink. This file came from this tutorial.

http://www.brightec.co.uk/blog/custom-android-media-controller

AsyncTask
=========

`AsyncTask` allows to perform background operations and publish results on the UI thread without having to manipulate threads and/or handlers.

BitmapTask
----------

This task takes the given URI of an image, scales, decodes and displays the resulting bitmap on the given image view.

Data
====

ContentListAdapter
------------------

Provides row views to the content list in `ContentListViewer` activity. The onstructor takes a list of `VideoProto.Video` and `ArticleProto.Article` objects.

### `getView()`
Returns the view of a specific row. Uses getItem(int) to get the data for that row, it's either `VideoProto.Video` or `ArticleProto.Article`, then constructs the view. An important thing here is to make the list efficient. Here we try to recycle a row view and also cache the bitmap.

DrawerItem
----------

This class corresponds to the item in the menu drawer in the ContentListActivity. Two reasons we use this class. One is that each item can be a header or a selectable item. Therefore each row's layout in the menu drawer depends on its type. Secondly, multiple items may be selected, therefore class implements Checkable to indicate whether the item is checked or not.

DrawerListAdapter
-----------------

Provides the row views to the menu drawer in the `ContentListViewer` activity. The constructor takes a list of `DrawerItem` objects.

### `getView()`
Returns the view of a specific row. 

Others
======

Constants
---------

Constants used in the app.

ExtraConstants
--------------

Constants used in sending data in an Intent.
